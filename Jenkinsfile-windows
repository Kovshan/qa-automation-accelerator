pipeline {
	agent any
	parameters {
	    choice(name: 'PLATFORM', choices: 'local\nsauceLabs\nbrowserStack', description: 'Select Platform')
		choice(name: 'BROWSER', choices: 'chrome\nfirefox\nIE', description: 'Select Browser')
		choice(name: 'MODE', choices: 'grid\nnormal', description: 'Select browser mode')
		string(name: 'DRIVER', defaultValue: 'drivers/linux/chromedriver_2_33', description: 'Enter Driver Path')
        choice(name: 'TARGET', choices: 'www\nstaging\nstaging2', description: 'Select Environment')
        choice(name: 'SELENIUM_GRID_NODE', choices: '5\n1\n2\n3\n4\n6\n7\n8\n9\n10', description: 'Select number of Nodes want to register')
        string(name: 'TAGS', defaultValue: '--tags @cbt', description: 'Enter tags here')
    }
    options {
		buildDiscarder(logRotator(numToKeepStr: '10'))
    }
	stages {
        	stage('Clean Workspace') {
        			steps {
        			    git 'https://github.com/mindstix-labs/qa-automation-accelerator.git/'
        				bat "./gradlew clean"
        			}        
        	}
    		stage('Test') {
                steps{
        		    executeTest("${params.PLATFORM}")
        	    }
        	}
	}
	post { 
        	always {
        			cucumber fileIncludePattern: '**/*.json', sortingMethod: 'ALPHABETICAL' 
            		notifyBuild(currentBuild.result)
        	}
        	
	}
}

def notifyBuild(String buildStatus = 'STARTED') {
     buildStatus =  buildStatus ?: 'SUCCESSFUL'

   // Default values
   def colorName = 'RED'
   def colorCode = '#FF0000'
   def subject = "${buildStatus}: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'"
   def summary = "${subject} (${env.BUILD_URL}cucumber-html-reports/overview-features.html)"
   def details = """
   		Jenkins Job: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]': (${env.BUILD_URL})
     	Report Link for Job '${env.JOB_NAME}' : ${env.BUILD_URL}cucumber-html-reports/overview-features.html
     	Latest Report Link: ${env.JENKINS_URL}job/${env.JOB_NAME}/lastCompletedBuild/cucumber-html-reports/overview-features.html
     """
   // Override default values based on build status
   if (buildStatus == 'STARTED') {
     color = 'YELLOW'
     colorCode = '#FFFF00'
   } else if (buildStatus == 'SUCCESSFUL') {
     color = 'GREEN'
     colorCode = '#00FF00'
   } else {
     color = 'RED'
     colorCode = '#FF0000'
   }

   // Step for sending a Jenkins build notification to specified Slack channel.
   slackSend (color: colorCode, message: details, channel: '#jenkins-notifications')

   // Step for sending a cucumber report to a slack channel.
   // We need to first configure Jenkins with "Incoming Webhook" link of slack channel to send cucumber report.
   cucumberSlackSend channel: '#jenkins-notifications', json: 'build/reports/cucumberreport/cucumber.json'

    // Step for sending a Jenkins build notification through mail. Please change the email id!
    mail (to: 'yourname@yourdomain.com',
    subject: subject,
    body: details);
}
def executeTest(String platform){
    	if(	platform.trim() == 'sauceLabs'){
		    sauce('2d4d492f-d432-4520-8807-8c3fb4d0d761') {
		    	sauceconnect(options: '', useGeneratedTunnelIdentifier: false, verboseLogging: false) {
		           bat "./gradlew clean test -Denv.browser=${params.BROWSER} -Denv.platform=${params.PLATFORM} -Denv.driverPath=${params.DRIVER} -Denv.threadCount=${params.SELENIUM_GRID_NODE} -Dcucumber.options=\"${params.TAGS}\""
		        }
		   	}
    	}	
	   	else if (platform.trim() == 'browserStack'){
	   		bat "./gradlew clean test -Denv.browser=${params.BROWSER} -Denv.platform=${params.PLATFORM} -Denv.driverPath=${params.DRIVER} -Denv.threadCount=${params.SELENIUM_GRID_NODE} -Dcucumber.options=\"${params.TAGS}\""
	   	} else{
	   		bat "./gradlew clean test -Denv.browser=${params.BROWSER} -Denv.platform=${params.PLATFORM} -Denv.driverPath=${params.DRIVER} -Denv.threadCount=${params.SELENIUM_GRID_NODE} -Dcucumber.options=\"${params.TAGS}\""
	   	}
	}